name: Bootstrap Documentation (ONE-TIME)

on:
  workflow_dispatch:  # Manual trigger only

permissions:
  contents: write
  pages: write

jobs:
  bootstrap:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: pip install requests
      
      - name: Find all code files
        run: |
          # Find all code files and add to changed_files.txt
          find . -type f \( -name "*.ts" -o -name "*.js" -o -name "*.py" -o -name "*.go" -o -name "*.rs" -o -name "*.java" -o -name "*.cpp" -o -name "*.c" -o -name "*.h" \) \
            ! -path "./.git/*" \
            ! -path "./node_modules/*" \
            ! -path "./.github/*" \
            > changed_files.txt
          
          echo "Found code files:"
          cat changed_files.txt
      
      - name: Generate documentation for all files
        env:
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
        run: python .github/scripts/generate-docs.py
      
      - name: Run code analysis
        env:
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          GITHUB_SHA: ${{ github.sha }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: python .github/scripts/code-analyzer.py
      
      - name: Route to Wiki
        env:
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: python .github/scripts/wiki-manager.py
      
      - name: Route to GitHub Pages
        env:
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
        run: python .github/scripts/pages-manager.py
      
      - name: Checkout Wiki
        uses: actions/checkout@v4
        continue-on-error: true
        id: checkout_wiki
        with:
          repository: ${{ github.repository }}.wiki
          path: wiki
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Update Wiki
        if: steps.checkout_wiki.outcome == 'success'
        run: |
          if [ -d "wiki_updates" ]; then
            cp -r wiki_updates/* wiki/ || true
            cd wiki
            git config --local user.email "github-actions[bot]@users.noreply.github.com"
            git config --local user.name "github-actions[bot]"
            git add .
            if ! git diff --staged --quiet; then
              git commit -m "docs: Bootstrap initial wiki documentation"
              git push
              echo "✓ Wiki bootstrapped"
            fi
          fi
      
      - name: Commit all documentation
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          git add docs/ CHANGELOG.md docs-site/ code-analysis/ .github/*-mapping.json analysis_*.* pages_summary.md wiki_summary.md || true
          
          if ! git diff --staged --quiet; then
            git commit -m "docs: Bootstrap initial documentation for all files [skip ci]"
            git push
            echo "✓ Documentation bootstrapped"
          else
            echo "No changes to commit"
          fi
      
      - name: Instructions
        run: |
          echo ""
          echo "=================================================="
          echo "✓ BOOTSTRAP COMPLETE!"
          echo "=================================================="
          echo ""
          echo "Documentation generated for all code files!"
          echo ""
          echo "Next steps:"
          echo "1. Check your wiki: https://github.com/${{ github.repository }}/wiki"
          echo "2. Check GitHub Pages: https://${{ github.repository_owner }}.github.io/CI-CD-Monitor-Test/"
          echo "3. DELETE this workflow file: .github/workflows/bootstrap-docs.yml"
          echo ""
          echo "From now on, docs will update automatically on every commit."
          echo ""
